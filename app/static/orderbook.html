<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8"/>
    <title>ETHUSDT Order Book (Top 20 Levels)</title>
    <style>
        body { margin: 5px; font-family: Arial, sans-serif; font-size: 0.8em; }
        .container { max-height: 85vh; overflow-y: auto; margin-bottom: 5px; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 5px; }
        th, td { border: 1px solid #888; padding: 2px; text-align: right; }
        th { background: #ccc; font-size: 0.9em; }
        .asks td { background-color: rgba(255, 0, 0, 0.1); }
        .bids td { background-color: rgba(0, 128, 0, 0.1); }
        .summary { font-size: 0.9em; margin-bottom: 5px; display: flex; justify-content: space-between; }
        h1 { font-size: 1.2em; margin: 5px 0; }
        h2 { font-size: 1em; margin: 5px 0; }
    </style>
</head>
<body>
    <h1>ETHUSDT Order Book (Top 20 Levels)</h1>
    <div class="summary">
        <div>
          <span id="asks-sum">Asks Sum: 0</span> |
          <span id="bids-sum">Bids Sum: 0</span>
        </div>
        <div>
          <span id="ask-speed">Ask Speed: 0</span> |
          <span id="bid-speed">Bid Speed: 0</span>
        </div>
    </div>
    <div class="container">
      <h2>Asks</h2>
      <table id="asks-table">
          <tr><th style="text-align:left">Price</th><th>Quantity</th></tr>
      </table>

      <h2>Bids</h2>
      <table id="bids-table">
          <tr><th style="text-align:left">Price</th><th>Quantity</th></tr>
      </table>
    </div>

    <script>
      let lastAskQty = null, askTimestamp = null;
      let lastBidQty = null, bidTimestamp = null;

      function renderTable(rows, tableId) {
          const table = document.getElementById(tableId);
          table.innerHTML = '<tr><th style="text-align:left">Price</th><th>Quantity</th></tr>';
          rows.forEach(([price, qty]) => {
              const tr = document.createElement('tr');
              tr.className = tableId === 'asks-table' ? 'asks' : 'bids';
              tr.innerHTML = `<td style="text-align:left; font-size:0.8em">${parseFloat(price).toFixed(2)}</td>` +
                             `<td style="font-size:0.8em">${parseFloat(qty).toFixed(6)}</td>`;
              table.appendChild(tr);
          });
      }

      async function fetchOrderbook() {
        try {
          const start = performance.now();
          const res = await fetch('/api/orderbook');
          const data = await res.json();

          const asks = (data.asks || []).sort((a,b) => b[0] - a[0]).slice(0,20);
          const bids = (data.bids || []).sort((a,b) => b[0] - a[0]).slice(0,20);

          // compute sums
          const askSum = asks.reduce((sum, [,q]) => sum + parseFloat(q), 0);
          const bidSum = bids.reduce((sum, [,q]) => sum + parseFloat(q), 0);
          document.getElementById('asks-sum').textContent = `Asks Sum: ${askSum.toFixed(6)}`;
          document.getElementById('bids-sum').textContent = `Bids Sum: ${bidSum.toFixed(6)}`;

          // compute first-level speed
          const [askPrice, askQty] = asks[0] || [0,0];
          const now = performance.now();
          if (lastAskQty !== null && askQty < lastAskQty) {
            const deltaQty = lastAskQty - askQty;
            const deltaTime = (now - askTimestamp) / 1000;
            const speed = deltaQty / deltaTime;
            document.getElementById('ask-speed').textContent = `Ask Speed: ${speed.toFixed(6)}`;
          }
          lastAskQty = askQty;
          askTimestamp = now;

          const [bidPrice, bidQty] = bids[0] || [0,0];
          if (lastBidQty !== null && bidQty < lastBidQty) {
            const deltaQtyB = lastBidQty - bidQty;
            const deltaTimeB = (now - bidTimestamp) / 1000;
            const speedB = deltaQtyB / deltaTimeB;
            document.getElementById('bid-speed').textContent = `Bid Speed: ${speedB.toFixed(6)}`;
          }
          lastBidQty = bidQty;
          bidTimestamp = now;

          renderTable(asks, 'asks-table');
          renderTable(bids, 'bids-table');
        } catch (err) {
          console.error('Fetch orderbook error', err);
        }
      }

      fetchOrderbook();
      setInterval(fetchOrderbook, 100);
    </script>
</body>
</html>