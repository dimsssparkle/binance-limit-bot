<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8"/>
    <title>ETHUSDT Order Book (Top 20 Levels)</title>
    <style>
        body { margin: 5px; font-family: Arial, sans-serif; }
        .wrapper { display: flex; gap: 10px; }
        .container { max-height: 100vh; overflow-y: auto; }
        table { width: 200px; border-collapse: collapse; font-size: 10px; margin-bottom: 5px; }
        th, td { border: 1px solid #888; padding: 2px; }
        th { background: #ccc; }
        th:first-child, td:first-child { width: 100px; text-align: left; }
        th:nth-child(2), td:nth-child(2) { width: 100px; text-align: right; }
        .asks td:nth-child(2), .bids td:nth-child(2) { transition: background-color 0.1s; }
        .stats table { margin-bottom: 10px; width: 250px; font-size: 10px; }
        .stats th, .stats td { padding: 2px; }
        .stats th:first-child, .stats td:first-child { width: 150px; text-align: left; }
        .stats th:nth-child(2), .stats td:nth-child(2) { width: 100px; text-align: right; }
        .insights { width: 250px; font-size: 10px; }
        .insights ul { padding-left: 16px; }
        .insights li { margin-bottom: 4px; }
        .info { font-size: 10px; margin: 5px 0; text-align: center; }
        h1 { font-size: 14px; margin: 5px 0; text-align: center; }
        h2 { font-size: 13px; margin: 3px 0; }
    </style>
</head>
<body>
    <h1>ETHUSDT Order Book</h1>
    <div class="wrapper">
      <div class="book">
        <div class="container">
          <h2>Asks</h2>
          <table id="asks-table">
            <tr><th>Price</th><th>Qty</th></tr>
          </table>
          <div class="info">
            Spread: <span id="spread">0.00</span> |
            Mid Price: <span id="mid-price">0.00</span> |
            Mark Price: <span id="mark-price">0.00</span>
          </div>
          <h2>Bids</h2>
          <table id="bids-table">
            <tr><th>Price</th><th>Qty</th></tr>
          </table>
        </div>
      </div>
      <div class="stats">
        <h2>Summary</h2>
        <table>
          <tr><td>Asks Sum</td><td id="asks-sum">0</td></tr>
          <tr><td>Bids Sum</td><td id="bids-sum">0</td></tr>
          <tr><td>Ask Speed</td><td id="ask-speed">0</td></tr>
          <tr><td>Bid Speed</td><td id="bid-speed">0</td></tr>
          <tr><td>Asks Table Speed</td><td id="asks-table-speed">0</td></tr>
          <tr><td>Bids Table Speed</td><td id="bids-table-speed">0</td></tr>
        </table>
        <div class="insights">
          <h2>Insights</h2>
          <ul>
            <li id="insight-liquidity">Liquidity: N/A</li>
            <li id="insight-demand">Demand Shift: N/A</li>
            <li id="insight-manipulation">Manipulation Signal: N/A</li>
            <li id="insight-timing">Entry Timing: N/A</li>
            <li id="insight-adaptive">Adaptive Spread: N/A</li>
          </ul>
        </div>
      </div>
    </div>

    <script>
      // Хранилища истории для скользящих показателей
      const historyLength = 10;
      let askSpeedHistory = [], bidSpeedHistory = [];
      let askTableSpeedHistory = [], bidTableSpeedHistory = [];

      function avg(arr) { return arr.reduce((a,b) => a+b, 0) / (arr.length || 1); }

      function fetchOrderbook() {
        const now = performance.now();
        fetch('/api/orderbook')
          .then(res => res.json())
          .then(data => {
            const asks = (data.asks || []).sort((a,b) => b[0] - a[0]).slice(0,20);
            const bids = (data.bids || []).sort((a,b) => b[0] - a[0]).slice(0,20);

            // Суммы
            const askSum = asks.reduce((sum, [,q]) => sum + parseFloat(q), 0);
            const bidSum = bids.reduce((sum, [,q]) => sum + parseFloat(q), 0);
            document.getElementById('asks-sum').textContent = askSum.toFixed(6);
            document.getElementById('bids-sum').textContent = bidSum.toFixed(6);

            // Скорости первого уровня
            let askSpeed = 0;
            const askQty = asks[0] ? parseFloat(asks[0][1]) : 0;
            if (window.lastAskQty !== undefined && askQty < window.lastAskQty) {
              const dQ = window.lastAskQty - askQty;
              askSpeed = dQ / ((now - window.lastAskTs) / 1000);
              document.getElementById('ask-speed').textContent = askSpeed.toFixed(6);
            }
            window.lastAskQty = askQty;
            window.lastAskTs = now;

            let bidSpeed = 0;
            const bidQty = bids[0] ? parseFloat(bids[0][1]) : 0;
            if (window.lastBidQty !== undefined && bidQty < window.lastBidQty) {
              const dQB = window.lastBidQty - bidQty;
              bidSpeed = dQB / ((now - window.lastBidTs) / 1000);
              document.getElementById('bid-speed').textContent = bidSpeed.toFixed(6);
            }
            window.lastBidQty = bidQty;
            window.lastBidTs = now;

            // Скорости суммы таблицы
            let askTableSpeed = 0;
            if (window.lastAskSum !== undefined && askSum < window.lastAskSum) {
              const dS = window.lastAskSum - askSum;
              askTableSpeed = dS / ((now - window.lastAskSumTs) / 1000);
              document.getElementById('asks-table-speed').textContent = askTableSpeed.toFixed(6);
            }
            window.lastAskSum = askSum;
            window.lastAskSumTs = now;

            let bidTableSpeed = 0;
            if (window.lastBidSum !== undefined && bidSum < window.lastBidSum) {
              const dSB = window.lastBidSum - bidSum;
              bidTableSpeed = dSB / ((now - window.lastBidSumTs) / 1000);
              document.getElementById('bids-table-speed').textContent = bidTableSpeed.toFixed(6);
            }
            window.lastBidSum = bidSum;
            window.lastBidSumTs = now;

            // Статус рынка
            askSpeedHistory.push(askSpeed);
            bidSpeedHistory.push(bidSpeed);
            askTableSpeedHistory.push(askTableSpeed);
            bidTableSpeedHistory.push(bidTableSpeed);
            if (askSpeedHistory.length > historyLength) askSpeedHistory.shift();
            if (bidSpeedHistory.length > historyLength) bidSpeedHistory.shift();
            if (askTableSpeedHistory.length > historyLength) askTableSpeedHistory.shift();
            if (bidTableSpeedHistory.length > historyLength) bidTableSpeedHistory.shift();

            const avgAskSpeed = avg(askSpeedHistory);
            const avgBidSpeed = avg(bidSpeedHistory);
            const avgAskTableSpeed = avg(askTableSpeedHistory);
            const avgBidTableSpeed = avg(bidTableSpeedHistory);

            // Обновляем Insights
            const liq = askSum + bidSum;
            document.getElementById('insight-liquidity').textContent = liq > 1000 ? 'High depth' : 'Low depth';
            document.getElementById('insight-demand').textContent = avgAskSpeed > avgBidSpeed ? 'Bullish impulse' : 'Bearish impulse';
            document.getElementById('insight-manipulation').textContent = avgAskTableSpeed > avgBidTableSpeed ? 'Hiding asks?' : 'Hiding bids?';
            document.getElementById('insight-timing').textContent = (avgAskSpeed < 1 && avgBidSpeed < 1) ? 'Calm market' : 'Volatile market';
            document.getElementById('insight-adaptive').textContent = liq < 500 ? 'Widen spread' : 'Tighten spread';

            // Вычисляем Spread, Mid Price и Mark Price
            const bestAsk = asks[asks.length-1] ? parseFloat(asks[asks.length-1][0]) : 0;
            const bestBid = bids[0] ? parseFloat(bids[0][0]) : 0;
            const spread = (bestAsk - bestBid).toFixed(2);
            const mid = ((bestAsk + bestBid) / 2).toFixed(2);
            document.getElementById('spread').textContent = spread;
            document.getElementById('mid-price').textContent = mid;

            // TODO: запросить Mark Price отдельно, если нужен внешний API call
            document.getElementById('mark-price').textContent = mid; // placeholder

            renderTable(asks, 'asks-table');
            renderTable(bids, 'bids-table');
          });
      }

      function renderTable(rows, tableId) {
          const table = document.getElementById(tableId);
          table.innerHTML = '<tr><th>Price</th><th>Qty</th></tr>';
          const maxQty = Math.max(...rows.map(r => parseFloat(r[1])), 0);
          rows.forEach(([price, qty]) => {
              const q = parseFloat(qty);
              const intensity = maxQty > 0 ? (q / maxQty) : 0;
              const bg = tableId === 'asks-table'
                ? `rgba(255,0,0,${intensity})`
                : `rgba(0,128,0,${intensity})`;
              const tr = document.createElement('tr');
              tr.innerHTML = `<td>${parseFloat(price).toFixed(2)}</td><td style="background:${bg}">${q.toFixed(6)}</td>`;
              table.appendChild(tr);
          });
      }

      // Запуск
      fetchOrderbook();
      setInterval(fetchOrderbook, 1000);
    </script>
</body>
</html>