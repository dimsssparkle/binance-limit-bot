<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8"/>
    <title>ETHUSDT Order Book (Top 20 Levels)</title>
    <style>
        body { margin: 5px; font-family: Arial, sans-serif; }
        .wrapper { display: flex; gap: 10px; }
        .container { max-height: 100vh; overflow-y: auto; }
        table { width: 200px; border-collapse: collapse; font-size: 10px; margin-bottom: 5px; }
        th, td { border: 1px solid #888; padding: 2px; }
        th { background: #ccc; }
        /* Asks/Bids table: 2 columns */
        #asks-table th:first-child, #bids-table td:first-child { width: 100px; text-align: left; }
        #asks-table th:nth-child(2), #bids-table td:nth-child(2) { width: 100px; text-align: right; }
        /* Price table: 3 columns */
        #price-table th, #price-table td { text-align: center; }
        #price-table th:first-child, #price-table td:first-child { width: 66px; }
        #price-table th:nth-child(2), #price-table td:nth-child(2) { width: 66px; }
        #price-table th:nth-child(3), #price-table td:nth-child(3) { width: 68px; }
        .stats table { margin-bottom: 10px; width: 250px; font-size: 10px; }
        .stats td { padding: 2px; }
        .stats td:first-child { width: 150px; }
        .stats td:nth-child(2) { width: 100px; text-align: right; }
        .insights { width: 250px; font-size: 10px; }
        .insights ul { padding-left: 16px; }
        .insights li { margin-bottom: 4px; padding: 2px; border-radius: 3px; }
        .insight-period { font-weight: bold; }
        .history { width: 450px; font-size: 10px; margin-top: 5px; }
        .history pre { background: #f4f4f4; padding: 5px; max-height: 100px; overflow-y: auto; white-space: pre-wrap; }
    </style>
</head>
<body>
    <h1>ETHUSDT Order Book</h1>
    <div class="wrapper">
      <div class="book">
        <div class="container">
          <!-- Asks Table -->
          <table id="asks-table"><tr><th>Price</th><th>Qty</th></tr></table>
          <!-- Price/Spread Table -->
          <table id="price-table">
            <tr><th>Mid Price</th><th>Mark Price</th><th>Spread</th></tr>
            <tr>
              <td id="mid-price">0.00</td>
              <td id="mark-price">0.00</td>
              <td id="spread">0.00</td>
            </tr>
          </table>
          <!-- Bids Table (no header) -->
          <table id="bids-table"></table>
        </div>
      </div>
      <div class="stats">
        <!-- Summary Metrics -->
        <table>
          <tr><td>Asks Sum</td><td id="asks-sum">0</td></tr>
          <tr><td>Bids Sum</td><td id="bids-sum">0</td></tr>
          <tr><td>Ask Speed</td><td id="ask-speed">0</td></tr>
          <tr><td>Bid Speed</td><td id="bid-speed">0</td></tr>
          <tr><td>Asks Table Speed</td><td id="asks-table-speed">0</td></tr>
          <tr><td>Bids Table Speed</td><td id="bids-table-speed">0</td></tr>
        </table>
        <!-- Insights Section -->
        <div class="insights">
          <h2>Insights <span class="insight-period">(last 20 ticks)</span></h2>
          <ul>
            <li id="insight-liquidity">Liquidity: N/A</li>
            <li id="insight-demand">Demand Shift: N/A</li>
            <li id="insight-manipulation">Manipulation Signal: N/A</li>
            <li id="insight-timing">Entry Timing: N/A</li>
            <li id="insight-adaptive">Adaptive Spread: N/A</li>
            <li id="insight-balance">Market Balance: N/A</li>
          </ul>
        </div>
      </div>
    </div>
    <!-- History Window -->
    <div class="history">
      <h2>Last 20 Ticks History (AskSpeed, BidSpeed)</h2>
      <pre id="history"></pre>
    </div>
    <script>
      const historyLength = 20;
      let askSpeedHistory = [], bidSpeedHistory = [];
      let askTableSpeedHistory = [], bidTableSpeedHistory = [];

      function avg(arr) { return arr.reduce((a,b)=>a+b,0)/(arr.length||1); }
      function colorize(el,label){
        if(/Bullish|Overbought|High depth/.test(label)) el.style.background='rgba(0,255,0,0.2)';
        else if(/Bearish|Oversold|Low depth/.test(label)) el.style.background='rgba(255,0,0,0.2)';
        else el.style.background='transparent';
      }
      function renderTable(rows,id,header){
        const t = document.getElementById(id);
        let html = header?'<tr><th>Price</th><th>Qty</th></tr>':'';
        const maxQ = Math.max(...rows.map(r=>parseFloat(r[1])),0);
        rows.forEach(([p,q])=>{
          const v = parseFloat(q);
          const i = maxQ? v/maxQ : 0;
          const bg = id==='asks-table'?`rgba(255,0,0,${i})`:`rgba(0,128,0,${i})`;
          html += `<tr><td>${parseFloat(p).toFixed(2)}</td><td style="background:${bg}">${v.toFixed(6)}</td></tr>`;
        });
        t.innerHTML = html;
      }
      function update(){
        const now = performance.now();
        fetch('/api/orderbook').then(r=>r.json()).then(data=>{
          const asks = (data.asks||[]).sort((a,b)=>b[0]-a[0]).slice(0,20);
          const bids = (data.bids||[]).sort((a,b)=>b[0]-a[0]).slice(0,20);
          const askSum = asks.reduce((s,[,q])=>s+parseFloat(q),0);
          const bidSum = bids.reduce((s,[,q])=>s+parseFloat(q),0);
          document.getElementById('asks-sum').textContent = askSum.toFixed(6);
          document.getElementById('bids-sum').textContent = bidSum.toFixed(6);

          let as=0, bs=0;
          const qa = parseFloat(asks[0]?.[1]||0);
          if(window.lqa!==undefined && qa<window.lqa){
            as = (window.lqa-qa)/((now-window.tqa)/1000);
            document.getElementById('ask-speed').textContent = as.toFixed(6);
          }
          window.lqa = qa; window.tqa = now;

          const qb = parseFloat(bids[0]?.[1]||0);
          if(window.lqb!==undefined && qb<window.lqb){
            bs = (window.lqb-qb)/((now-window.tqb)/1000);
            document.getElementById('bid-speed').textContent = bs.toFixed(6);
          }
          window.lqb = qb; window.tqb = now;

          let ats=0, bts=0;
          if(window.las!==undefined && askSum<window.las){
            ats = (window.las-askSum)/((now-window.tas)/1000);
            document.getElementById('asks-table-speed').textContent = ats.toFixed(6);
          }
          window.las = askSum; window.tas = now;
          if(window.lbs!==undefined && bidSum<window.lbs){
            bts = (window.lbs-bidSum)/((now-window.tbs)/1000);
            document.getElementById('bids-table-speed').textContent = bts.toFixed(6);
          }
          window.lbs = bidSum; window.tbs = now;

          askSpeedHistory.push(as); if(askSpeedHistory.length>historyLength) askSpeedHistory.shift();
          bidSpeedHistory.push(bs); if(bidSpeedHistory.length>historyLength) bidSpeedHistory.shift();
          askTableSpeedHistory.push(ats); if(askTableSpeedHistory.length>historyLength) askTableSpeedHistory.shift();
          bidTableSpeedHistory.push(bts); if(bidTableSpeedHistory.length>historyLength) bidTableSpeedHistory.shift();

          const avgAs = avg(askSpeedHistory), avgBs = avg(bidSpeedHistory), avgAts = avg(askTableSpeedHistory), avgBts = avg(bidTableSpeedHistory);
          const depth = askSum + bidSum;
          const depthL = depth>1000?'High depth':'Low depth';
          const dm = Math.abs(avgAs-avgBs)<1?'No impulse':(avgAs>avgBs?'Bullish impulse':'Bearish impulse');
          const mp = Math.abs(avgAts-avgBts)<1?'No manipulation':(avgAts>avgBts?'Hiding asks?':'Hiding bids?');
          const spEl = document.getElementById('spread');
          const bestB = parseFloat(bids[0]?.[0]||0), bestA = parseFloat(asks[asks.length-1]?.[0]||0);
          const sp = (bestA-bestB).toFixed(2);
          spEl.textContent = sp;
          const ap = parseFloat(sp)>0.5?'Widen spread':'Tighten spread';
          const mid = ((bestA+bestB)/2).toFixed(2);
          document.getElementById('mid-price').textContent = mid;
          document.getElementById('mark-price').textContent = mid;
          const br = bidSum/askSum;
          let bl = 'Balanced'; if(br>1.2) bl='Overbought'; else if(br<0.8) bl='Oversold';

          document.getElementById('insight-liquidity').textContent    = `Liquidity (${historyLength}): ${depthL}`; colorize(document.getElementById('insight-liquidity'), depthL);
          document.getElementById('insight-demand').textContent       = `Demand Shift (${historyLength}): ${dm}`;    colorize(document.getElementById('insight-demand'), dm);
          document.getElementById('insight-manipulation').textContent = `Manipulation Signal (${historyLength}): ${mp}`; colorize(document.getElementById('insight-manipulation'), mp);
          document.getElementById('insight-timing').textContent       = `Entry Timing (${historyLength}): ${(avgAs<1&&avgBs<1)?'Calm market':'Volatile market'}`; colorize(document.getElementById('insight-timing'), document.getElementById('insight-timing').textContent);
          document.getElementById('insight-adaptive').textContent     = `Adaptive Spread (${historyLength}): ${ap}`; colorize(document.getElementById('insight-adaptive'), ap);
          document.getElementById('insight-balance').textContent      = `Market Balance (${historyLength}): ${bl}`;  colorize(document.getElementById('insight-balance'), bl);

          document.getElementById('history').textContent =
            `AskSpeed: ${askSpeedHistory.map(v=>v.toFixed(2)).join(', ')}\nBidSpeed: ${bidSpeedHistory.map(v=>v.toFixed(2)).join(', ')}`;

          renderTable(asks,'asks-table',true);
          renderTable(bids,'bids-table',false);
        });
      }

      // Start updates
      update();
      setInterval(update, 50);
    </script>
</body>
</html>