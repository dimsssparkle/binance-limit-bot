<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8"/>
    <title>ETHUSDT Order Book (Top 20 Levels)</title>
    <style>
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        th, td { border: 1px solid #888; padding: 8px; text-align: center; }
        th { background: #ddd; }
        caption { font-size: 1.5em; margin-bottom: 10px; }
    </style>
</head>
<body>
    <h1>ETHUSDT Order Book (Top 20 Levels)</h1>

    <h2>Asks</h2>
    <table id="asks-table">
        <tr><th>Price</th><th>Quantity</th></tr>
    </table>

    <h2>Bids</h2>
    <table id="bids-table">
        <tr><th>Price</th><th>Quantity</th></tr>
    </table>

    <script>
      const protocol = location.protocol === 'https:' ? 'wss://' : 'ws://';
      const socket = new WebSocket(protocol + location.host + '/ws');

      socket.onopen = () => console.log('WS connected');
      socket.onerror = e => console.error('WebSocket error', e);

      socket.onclose = ev => {
        console.warn('WebSocket closed', ev.code, ev.reason);
        // попытаться переподключиться через секунду
        setTimeout(() => location.reload(), 1000);
      };

    socket.onmessage = event => {
        const data = JSON.parse(event.data);
        const asks = data.asks || [];
        const bids = data.bids || [];

        function renderTable(rows, tableId, reverse=false) {
            const table = document.getElementById(tableId);
            // Очищаем все, кроме заголовка
            table.innerHTML = '<tr><th>Price</th><th>Quantity</th></tr>';
            const slice = reverse ? rows.slice(0, 20) : rows.slice(0, 20);
            if (!rows.length) return;
            slice.forEach(([price, qty]) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${parseFloat(price).toFixed(2)}</td><td>${parseFloat(qty).toFixed(6)}</td>`;
                table.appendChild(tr);
            });
        }

        // Asks: от самого дорогого вниз
        renderTable(asks.sort((a,b) => b[0] - a[0]), 'asks-table');
        // Bids: от самого дорогого вниз
        renderTable(bids.sort((a,b) => b[0] - a[0]), 'bids-table');
    };
    </script>
</body>
</html>
