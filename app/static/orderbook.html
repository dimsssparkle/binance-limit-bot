<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <title>ETHUSDT Order Book</title>
    <style>
        body { margin: 10px; font-family: Arial, sans-serif; }
        table { width: 400px; border-collapse: collapse; font-size: 14px; margin-bottom: 20px; }
        th, td { border: 1px solid #888; padding: 6px; text-align: center; }
        th { background: #f0f0f0; }
        /* Price table specific */
        .mid-price { text-align: left; border-top: none; border-bottom: none; }
        .mark-price, .spread { border-top: none; border-bottom: none; }
    </style>
</head>
<body>
    <h1>ETHUSDT Order Book</h1>

    <!-- Asks Table -->
    <table id="asks-table">
        <thead>
            <tr><th>Price</th><th>Qty</th></tr>
        </thead>
        <tbody></tbody>
    </table>

    <!-- Mid / Mark / Spread Table -->
    <table id="price-table">
        <thead>
            <tr><th>Mid Price</th><th>Mark Price</th><th>Spread</th></tr>
        </thead>
        <tbody>
            <tr>
                <td id="mid-price" class="mid-price">0.00</td>
                <td id="mark-price" class="mark-price">0.00</td>
                <td id="spread" class="spread">0.00</td>
            </tr>
        </tbody>
    </table>

    <!-- Bids Table -->
    <table id="bids-table">
        <thead>
            <tr><th>Price</th><th>Qty</th></tr>
        </thead>
        <tbody></tbody>
    </table>

    <script>
        function renderBook(data) {
            const rawAsks = data.asks || [];
            const rawBids = data.bids || [];
            const asks = rawAsks.sort((a,b) => parseFloat(b[0]) - parseFloat(a[0])).slice(0, 20);
            const bids = rawBids.sort((a,b) => parseFloat(b[0]) - parseFloat(a[0])).slice(0, 20);

            const asksBody = document.querySelector('#asks-table tbody');
            const bidsBody = document.querySelector('#bids-table tbody');
            asksBody.innerHTML = '';
            bidsBody.innerHTML = '';

            asks.forEach(([price, qty]) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${parseFloat(price).toFixed(2)}</td>
                    <td>${parseFloat(qty).toFixed(6)}</td>
                `;
                asksBody.appendChild(tr);
            });

            bids.forEach(([price, qty]) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${parseFloat(price).toFixed(2)}</td>
                    <td>${parseFloat(qty).toFixed(6)}</td>
                `;
                bidsBody.appendChild(tr);
            });

            updatePrices(asks[0], bids[0]);
        }

        function updatePrices(bestAsk, bestBid) {
            const askPrice = bestAsk ? parseFloat(bestAsk[0]) : 0;
            const bidPrice = bestBid ? parseFloat(bestBid[0]) : 0;
            const mid = ((askPrice + bidPrice) / 2).toFixed(2);
            const spread = (askPrice - bidPrice).toFixed(2);

            document.getElementById('mid-price').textContent = mid;
            document.getElementById('mark-price').textContent = mid;
            document.getElementById('spread').textContent = spread;
        }

        async function update() {
            try {
                const resp = await fetch('/api/orderbook');
                const data = await resp.json();
                renderBook(data);
            } catch (e) {
                console.error('Failed to fetch order book:', e);
            }
        }

        // Запуск обновлений каждые 100 мс
        update();
        setInterval(update, 100);
    </script>
</body>
</html>