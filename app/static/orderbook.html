<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8"/>
    <title>ETHUSDT Order Book (Top 20 Levels)</title>
    <style>
        body { margin: 5px; font-family: Arial, sans-serif; }
        .wrapper { display: flex; gap: 10px; }
        .book, .stats { width: 200px; }
        .container { max-height: 85vh; overflow-y: auto; }
        table { width: 200px; border-collapse: collapse; font-size: 12px; margin-bottom: 5px; }
        th, td { border: 1px solid #888; padding: 2px; }
        th { background: #ccc; }
        th:first-child, td:first-child { width: 100px; text-align: left; }
        th:nth-child(2), td:nth-child(2) { width: 100px; text-align: right; }
        .asks td { /* base color for asks */ }
        .bids td { /* base color for bids */ }
        .stats table { margin-bottom: 3px; width: 250px; }
        .stats th, .stats td { font-size: 12px; padding: 2px; }
        .stats th:first-child, .stats td:first-child { width: 150px; text-align: left; }
        .stats th:nth-child(2), .stats td:nth-child(2) { width: 100px; text-align: right; }
        h1 { font-size: 14px; margin: 5px 0; text-align: center; }
        h2 { font-size: 13px; margin: 3px 0; }
    </style>
</head>
<body>
    <h1>ETHUSDT Order Book</h1>
    <div class="wrapper">
      <div class="book">
        <div class="container">
          <h2>Asks</h2>
          <table id="asks-table">
            <tr><th>Price</th><th>Qty</th></tr>
          </table>
          <h2>Bids</h2>
          <table id="bids-table">
            <tr><th>Price</th><th>Qty</th></tr>
          </table>
        </div>
      </div>
      <div class="stats">
        <h2>Summary</h2>
        <table>
          <tr><td>Asks Sum</td><td id="asks-sum">0</td></tr>
          <tr><td>Bids Sum</td><td id="bids-sum">0</td></tr>
          <tr><td>Ask Speed</td><td id="ask-speed">0</td></tr>
          <tr><td>Bid Speed</td><td id="bid-speed">0</td></tr>
          <tr><td>Asks Table Speed</td><td id="asks-table-speed">0</td></tr>
          <tr><td>Bids Table Speed</td><td id="bids-table-speed">0</td></tr>
        </table>
      </div>
    </div>

    <script>
      let lastAskQty = null, askTimestamp = null;
      let lastBidQty = null, bidTimestamp = null;
      let lastAskSum = null, askSumTimestamp = null;
      let lastBidSum = null, bidSumTimestamp = null;

      function renderTable(rows, tableId) {
          const table = document.getElementById(tableId);
          table.innerHTML = '<tr><th>Price</th><th>Qty</th></tr>';
          // вычисляем max quantity для интенсивности
          const qs = rows.map(r => parseFloat(r[1]));
          const maxQty = Math.max(...qs, 0);
          rows.forEach(([price, qty]) => {
              const q = parseFloat(qty);
              const intensity = maxQty > 0 ? (q / maxQty) : 0;
              const bg = tableId === 'asks-table'
                ? `rgba(255,0,0,${intensity})`
                : `rgba(0,128,0,${intensity})`;
              const tr = document.createElement('tr');
              tr.innerHTML = `<td>${parseFloat(price).toFixed(2)}</td>` +
                             `<td style="background:${bg}">${q.toFixed(6)}</td>`;
              table.appendChild(tr);
          });
      }

      async function fetchOrderbook() {
        try {
          const now = performance.now();
          const res = await fetch('/api/orderbook');
          const data = await res.json();

          const asks = (data.asks || []).sort((a,b) => b[0] - a[0]).slice(0,20);
          const bids = (data.bids || []).sort((a,b) => b[0] - a[0]).slice(0,20);

          const askSum = asks.reduce((sum, [,q]) => sum + parseFloat(q), 0);
          const bidSum = bids.reduce((sum, [,q]) => sum + parseFloat(q), 0);
          document.getElementById('asks-sum').textContent = askSum.toFixed(6);
          document.getElementById('bids-sum').textContent = bidSum.toFixed(6);

          const askQty = asks[0] ? parseFloat(asks[0][1]) : 0;
          if (lastAskQty !== null && askQty < lastAskQty) {
            const deltaQty = lastAskQty - askQty;
            const deltaTime = (now - askTimestamp) / 1000;
            document.getElementById('ask-speed').textContent = (deltaQty / deltaTime).toFixed(6);
          }
          lastAskQty = askQty;
          askTimestamp = now;

          const bidQty = bids[0] ? parseFloat(bids[0][1]) : 0;
          if (lastBidQty !== null && bidQty < lastBidQty) {
            const deltaQtyB = lastBidQty - bidQty;
            const deltaTimeB = (now - bidTimestamp) / 1000;
            document.getElementById('bid-speed').textContent = (deltaQtyB / deltaTimeB).toFixed(6);
          }
          lastBidQty = bidQty;
          bidTimestamp = now;

          if (lastAskSum !== null && askSum < lastAskSum) {
            const deltaSum = lastAskSum - askSum;
            const dt = (now - askSumTimestamp) / 1000;
            document.getElementById('asks-table-speed').textContent = (deltaSum / dt).toFixed(6);
          }
          lastAskSum = askSum;
          askSumTimestamp = now;

          if (lastBidSum !== null && bidSum < lastBidSum) {
            const deltaSumB = lastBidSum - bidSum;
            const dtB = (now - bidSumTimestamp) / 1000;
            document.getElementById('bids-table-speed').textContent = (deltaSumB / dtB).toFixed(6);
          }
          lastBidSum = bidSum;
          bidSumTimestamp = now;

          renderTable(asks, 'asks-table');
          renderTable(bids, 'bids-table');
        } catch (err) {
          console.error('Fetch orderbook error', err);
        }
      }

      fetchOrderbook();
      setInterval(fetchOrderbook, 100);
    </script>
</body>
</html>
