<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8"/>
    <title>ETHUSDT Order Book (Top 20 Levels)</title>
    <style>
        body { margin: 5px; font-family: Arial, sans-serif; }
        .wrapper { display: flex; gap: 10px; }
        .container { max-height: 100vh; overflow-y: auto; }
        table { width: 200px; border-collapse: collapse; font-size: 10px; margin-bottom: 0; }
        th, td { border: 1px solid #888; padding: 2px; }
        /* Asks/Bids table: 2 columns */
        #asks-table td:first-child, #bids-table td:first-child { width: 100px; text-align: left; }
        #asks-table td:nth-child(2), #bids-table td:nth-child(2) { width: 100px; text-align: right; }
        /* Price table: 3 columns */
        #price-table td { text-align: center; }
        #price-table td:nth-child(1) { width: 66px; }
        #price-table td:nth-child(2) { width: 66px; }
        #price-table td:nth-child(3) { width: 68px; }
        .stats table { margin-bottom: 10px; width: 250px; font-size: 10px; }
        .stats td { padding: 2px; }
        .stats td:first-child { width: 150px; }
        .stats td:nth-child(2) { width: 100px; text-align: right; }
        .insights { width: 250px; font-size: 10px; }
        .insights ul { padding-left: 16px; }
        .insights li { margin-bottom: 4px; padding: 2px; border-radius: 3px; }
        .insight-period { font-weight: bold; }
    </style>
</head>
<body>
    <h1>ETHUSDT Order Book</h1>
    <div class="wrapper">
      <div class="book">
        <div class="container">
          <!-- Asks Table -->
          <table id="asks-table"></table>
          <!-- Price/Spread Table -->
          <table id="price-table">
            <tr>
              <td id="mid-price" class="mid-price" style="text-align: left; border-bottom: none; border-top: none;">0.00</td>
              <td id="mark-price" class="mark-price" style="border-bottom: none; border-top: none;">0.00</td>
              <td id="spread"    class="spread"    style="border-bottom: none; border-top: none;">0.00</td>
            </tr>
          </table>
          <!-- Bids Table -->
          <table id="bids-table"></table>
        </div>
      </div>
      <div class="stats">
        <!-- Summary Metrics -->
        <table>
          <tr><td>Asks Sum</td><td id="asks-sum">0</td></tr>
          <tr><td>Bids Sum</td><td id="bids-sum">0</td></tr>
          <tr><td>Ask Speed</td><td id="ask-speed">0</td></tr>
          <tr><td>Bid Speed</td><td id="bid-speed">0</td></tr>
          <tr><td>Asks Table Speed</td><td id="asks-table-speed">0</td></tr>
          <tr><td>Bids Table Speed</td><td id="bids-table-speed">0</td></tr>
        </table>
        <!-- Insights Section -->
        <div class="insights">
          <h2>Insights <span class="insight-period">(last 20 ticks)</span></h2>
          <ul>
            <li id="insight-liquidity">Liquidity: N/A</li>
            <li id="insight-demand">Demand Shift: N/A</li>
            <li id="insight-manipulation">Manipulation Signal: N/A</li>
            <li id="insight-timing">Entry Timing: N/A</li>
            <li id="insight-adaptive">Adaptive Spread: N/A</li>
            <li id="insight-balance">Market Balance: N/A</li>
          </ul>
        </div>
      </div>
    </div>
    <!-- History Window disabled -->
    <script>
      // --- Пороговые значения (настроены) ---
      const DEPTH_HIGH                = 2000;
      const DEPTH_LOW                 = 500;
      const SPEED_IMPULSE_THRESHOLD   = 0.5;
      const MANIPULATION_THRESHOLD    = 0.5;
      const QUIET_SPEED_THRESHOLD     = 0.2;
      const SPREAD_THRESHOLD          = 0.5;
      const BALANCE_OVERBOUGHT_THRESH = 1.5;
      const BALANCE_OVERSOLD_THRESH   = 0.5;

      const historyLength = 20;
      let askSpeedHistory = [], bidSpeedHistory = [];
      let askTableSpeedHistory = [], bidTableSpeedHistory = [];

      function avg(arr) { return arr.reduce((a,b)=>a+b,0)/(arr.length||1); }
      function colorize(el, label){
        if (/Bullish|Overbought|High depth/.test(label)) el.style.background = 'rgba(0,255,0,0.2)';
        else if (/Bearish|Oversold|Low depth/.test(label)) el.style.background = 'rgba(255,0,0,0.2)';
        else el.style.background = 'transparent';
      }

      function renderTable(rows, id){
        const t = document.getElementById(id);
        let html = '';
        const maxQ = Math.max(...rows.map(r=>parseFloat(r[1])), 0);
        rows.forEach(([p,q])=>{
          const v = parseFloat(q), intensity = maxQ ? v/maxQ : 0;
          const bg = id === 'asks-table' ? `rgba(255,0,0,${intensity})` : `rgba(0,128,0,${intensity})`;
          html += `<tr><td>${parseFloat(p).toFixed(2)}</td><td style="background:${bg}">${v.toFixed(6)}</td></tr>`;
        });
        t.innerHTML = html;
      }

      function update(){
        const now = performance.now();
        fetch('/api/orderbook').then(r=>r.json()).then(data=>{
          // Данные
          const asks = (data.asks||[]).sort((a,b)=>b[0]-a[0]).slice(0,20);
          const bids = (data.bids||[]).sort((a,b)=>b[0]-a[0]).slice(0,20);
          const askSum = asks.reduce((s,[,q])=>s+parseFloat(q),0);
          const bidSum = bids.reduce((s,[,q])=>s+parseFloat(q),0);
          document.getElementById('asks-sum').textContent = askSum.toFixed(6);
          document.getElementById('bids-sum').textContent = bidSum.toFixed(6);

          // Скорости изменений (абсолютные)
          let aspeed = 0, bspeed = 0, atablespeed = 0, btablespeed = 0;
          const qa = parseFloat(asks[0]?.[1]||0);
          if (window.lqa !== undefined) aspeed = Math.abs(window.lqa - qa) / ((now - window.tqa)/1000);
          window.lqa = qa; window.tqa = now;

          const qb = parseFloat(bids[0]?.[1]||0);
          if (window.lqb !== undefined) bspeed = Math.abs(window.lqb - qb) / ((now - window.tqb)/1000);
          window.lqb = qb; window.tqb = now;

          if (window.las !== undefined) atablespeed = Math.abs(window.las - askSum) / ((now - window.tas)/1000);
          window.las = askSum; window.tas = now;

          if (window.lbs !== undefined) btablespeed = Math.abs(window.lbs - bidSum) / ((now - window.tbs)/1000);
          window.lbs = bidSum; window.tbs = now;

          document.getElementById('ask-speed').textContent = aspeed.toFixed(6);
          document.getElementById('bid-speed').textContent = bspeed.toFixed(6);
          document.getElementById('asks-table-speed').textContent = atablespeed.toFixed(6);
          document.getElementById('bids-table-speed').textContent = btablespeed.toFixed(6);

          // Продолжаем остальную логику...
          const avgAs = avg(askSpeedHistory), avgBs = avg(bidSpeedHistory);
          const avgAts = avg(askTableSpeedHistory), avgBts = avg(bidTableSpeedHistory);
          const totalDepth = askSum + bidSum;
          let depthLabel;
          if (totalDepth >= DEPTH_HIGH) depthLabel = 'High depth';
          else if (totalDepth <= DEPTH_LOW && avgAs < avgBs) depthLabel = 'Low depth';
          else depthLabel = 'Medium depth';
          document.getElementById('insight-liquidity').textContent = `Liquidity (${historyLength}): ${depthLabel}`;
          colorize(document.getElementById('insight-liquidity'), depthLabel);

          let shiftLabel = Math.abs(avgAs-avgBs) < SPEED_IMPULSE_THRESHOLD
            ? 'No impulse'
            : (avgAs>avgBs ? 'Bullish impulse' : 'Bearish impulse');
          document.getElementById('insight-demand').textContent = `Demand Shift (${historyLength}): ${shiftLabel}`;
          colorize(document.getElementById('insight-demand'), shiftLabel);

          let manipLabel = Math.abs(avgAts-avgBts) < MANIPULATION_THRESHOLD
            ? 'No manipulation'
            : (avgAts>avgBts ? 'Hiding asks?' : 'Hiding bids?');
          document.getElementById('insight-manipulation').textContent = `Manipulation Signal (${historyLength}): ${manipLabel}`;
          colorize(document.getElementById('insight-manipulation'), manipLabel);

          const timingLabel = (avgAs<QUIET_SPEED_THRESHOLD && avgBs<QUIET_SPEED_THRESHOLD)
            ? 'Calm market' : 'Volatile market';
          document.getElementById('insight-timing').textContent = `Entry Timing (${historyLength}): ${timingLabel}`;
          colorize(document.getElementById('insight-timing'), timingLabel);

          const bestB = parseFloat(bids[0]?.[0]||0), bestA = parseFloat(asks[asks.length-1]?.[0]||0);
          const spreadVal = +(bestA-bestB).toFixed(2);
          document.getElementById('spread').textContent = spreadVal.toFixed(2);
          const adaptiveLabel = spreadVal <= SPREAD_THRESHOLD ? 'Tighten spread' : 'Widen spread';
          document.getElementById('insight-adaptive').textContent = `Adaptive Spread (${historyLength}): ${adaptiveLabel}`;
          colorize(document.getElementById('insight-adaptive'), adaptiveLabel);

          const balanceRatio = bidSum/askSum;
          let balanceLabel = balanceRatio > BALANCE_OVERBOUGHT_THRESH
            ? 'Overbought'
            : (balanceRatio < BALANCE_OVERSOLD_THRESH ? 'Oversold' : 'Balanced');
          document.getElementById('insight-balance').textContent = `Market Balance (${historyLength}): ${balanceLabel}`;
          colorize(document.getElementById('insight-balance'), balanceLabel);

          const midPrice = ((bestA+bestB)/2).toFixed(2);
          document.getElementById('mid-price').textContent = midPrice;
          document.getElementById('mark-price').textContent = midPrice;

          renderTable(asks, 'asks-table');
          renderTable(bids, 'bids-table');
        });
      }

      update();
      setInterval(update, 50);
    </script>
</body>
</html>